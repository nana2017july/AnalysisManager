##
##  Makefile -- Build procedure for sample hello_world Apache module
##  Autogenerated via ``apxs -n hello_world -g''.
##
## 参考：http://blogs.yahoo.co.jp/take_low_6/23875145.html
##

MY_INCLUDES  :=-I./util_analysis_manager/ -I./test/test_am/

#環境に合わせて以下のファイルの先頭の定義を書き変える
include ./common.mk



#
MAIN_BIN      :=mod_replace_content.so
MOD_SRC_DIR   :=mod_replace_content
#
AM_SRC_DIR    :=util_analysis_manager
D_AM_SRCS_C   :=d/analysis_executor_multipart.c d/analysis_parser_impl.c d/analysis_parser.c d/ac_this_is_class.c d/ac_bucket_utils.c d/analysis_manager.c d/analysis_executor_partial_match.c d/analysis_executor_htmltag_replace.c d/analysis_executor_donothing.c
AM_SRCS_C     :=$(patsubst d/%,$(AM_SRC_DIR)/%,$(D_AM_SRCS_C)) 
#SRCS_CPP  :=
AM_OBJS       :=$(patsubst %.c,%.o,$(AM_SRCS_C)) 
TEST_AM_SRC_DIR:=test/test_am
D_TEST_AM_SRCS_C:=d/test_analysis_executor_multipart.c d/test_analysis_parser_split.c d/test_analysis_parser_insensitive.c d/test_analysis_parser_http_header.c d/test_bucket_utils.c d/test_analysis_manager.c d/test_analysis_executor_htmltag_replace.c d/test_bucket_controller.c d/sctest_utils.c
TEST_AM_SRCS_C:=$(patsubst d/%,$(TEST_AM_SRC_DIR)/%,$(D_TEST_AM_SRCS_C)) 
TEST_AM_OBJS  :=$(patsubst %.c,%.o,$(TEST_AM_SRCS_C))
BIN        := main



#------------------------------------------
#   main target 
all: $(AM_OBJS) $(MOD_SRC_DIR)/dllmain.o
	$(CC) -shared -Wall $(APXS_LIBS_SHLIB) $(LIBS) $(CXXFLAGS) $(AM_OBJS) $(MOD_SRC_DIR)/dllmain.o -o $(MAIN_BIN)


$(MOD_SRC_DIR)/%.o: %.c
	$(CC) $(APXS_LIBS_SHLIB) $(LIBS) $(CXXFLAGS) -c -o $@ $<

$(AM_SRC_DIR)/%.o: %.c
	$(CC) $(APXS_LIBS_SHLIB) $(LIBS) $(CXXFLAGS) -c -o $@ $<

$(TEST_AM_SRC_DIR)/%.o: %.c
	$(CC) $(APXS_LIBS_SHLIB) $(LIBS) $(CXXFLAGS) -c -o $@ $<


#テスト実行
.PHONY: test_am
test_am: test_am_main
	./test_am_main

#テスト用のexe作成
test_am_main: $(AM_OBJS) $(TEST_AM_OBJS) $(TEST_AM_SRC_DIR)/test_am_main.o
	$(CXX) $(APXS_LIBS_SHLIB) $(LIBS) $(CXXFLAGS) $(AM_OBJS) $(TEST_AM_OBJS) $(TEST_AM_SRC_DIR)/test_am_main.o -o test_am_main




#   cleanup
.PHONY: clean
clean:
	$(RM) $(PROGRAM) $(AM_OBJS) $(TEST_AM_OBJS) $(TEST_AM_SRC_DIR)/test_am_main.o test_main $(MOD_SRC_DIR)/dllmain.o $(MAIN_BIN) depend.inc


# ヘッダファイルの依存関係
.PHONY: depend
depend: $(AM_OBJS:.o=.c)
	-@ $(RM) depend.inc
	-@ for i in $^; do cpp -MM $$i | sed "s/\ [_a-zA-Z0-9][_a-zA-Z0-9]*\.c//g" >> depend.inc; done

-include depend.inc

#   install the shared object file into Apache   install-modules-yes
install:
	$(APR_LIB_DIR)/apr-1/build/libtool --silent --mode=install cp $(MAIN_BIN) $(APXS_LIBEXECDIR)
	

#   the general Apache start/restart/stop
#   procedures
start:
	$(APACHECTL) start
restart:
	$(APACHECTL) restart
stop:
	$(APACHECTL) stop

